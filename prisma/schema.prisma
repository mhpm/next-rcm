generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Churches {
  id               String           @id @default(cuid())
  name             String
  slug             String           @unique
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  memberMinistries MemberMinistry[]
  members          Members[]
  ministries       Ministries[]
  cells            Cells[]
  sectors          Sectors[]
  groups           Groups[]

  @@map("churches")
}

model Members {
  id           String           @id @default(cuid())
  firstName    String           @map("first_name")
  lastName     String           @map("last_name")
  email        String?          @unique
  phone        String?
  age          Int?
  street       String?
  city         String?
  state        String?
  zip          String?
  country      String?          @default("MÃ©xico")
  birthDate    DateTime?        @map("birth_date")
  baptismDate  DateTime?        @map("baptism_date")
  role         MemberRole       @default(MIEMBRO)
  gender       Gender           @default(MASCULINO)
  pictureUrl   String?          @map("picture_url")
  notes        String?
  passwordHash String?          @map("password_hash")
  church_id    String
  sector_id    String?
  cell_id      String?
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")
  ministries   MemberMinistry[]

  church        Churches     @relation(fields: [church_id], references: [id], onDelete: Cascade)
  ledMinistries Ministries[] @relation("MinistryLeader")
  cells         Cells[]      @relation("CellLeader")
  hostedCells   Cells[]      @relation("CellHost")
  cell          Cells?       @relation("MemberCell", fields: [cell_id], references: [id], onDelete: SetNull)
  sector        Sectors?     @relation("MemberSector", fields: [sector_id], references: [id], onDelete: SetNull)
  ledSectors    Sectors[]    @relation("SectorLeader")
  groups        Groups[]     @relation("MemberGroup")
  ledGroups     Groups[]     @relation("GroupLeader")

  @@index([email])
  @@index([role])
  @@index([createdAt])
  @@index([church_id])
  @@index([cell_id])
  @@index([sector_id])
  @@map("members")
}

model Ministries {
  id          String           @id @default(cuid())
  name        String
  description String?
  church_id   String
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")
  leader_id   String?
  members     MemberMinistry[]
  church      Churches         @relation(fields: [church_id], references: [id], onDelete: Cascade)
  leader      Members?         @relation("MinistryLeader", fields: [leader_id], references: [id])

  @@unique([name, church_id])
  @@index([church_id])
  @@index([leader_id])
  @@map("ministries")
}

model Cells {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  church_id String
  sector_id String?
  leader_id String?
  host_id   String?

  church  Churches  @relation(fields: [church_id], references: [id], onDelete: Cascade)
  sector  Sectors?  @relation(fields: [sector_id], references: [id], onDelete: Cascade)
  leader  Members?  @relation("CellLeader", fields: [leader_id], references: [id])
  host    Members?  @relation("CellHost", fields: [host_id], references: [id])
  members Members[] @relation("MemberCell")

  @@index([church_id])
  @@index([sector_id])
  @@index([leader_id])
  @@index([host_id])
}

model Sectors {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  church_id String
  leader_id String?

  church  Churches  @relation(fields: [church_id], references: [id], onDelete: Cascade)
  cells   Cells[]
  leader  Members?  @relation("SectorLeader", fields: [leader_id], references: [id])
  members Members[] @relation("MemberSector")

  @@index([church_id])
  @@index([leader_id])
  @@map("sectors")
}

model Groups {
  id        String   @id @default(cuid())
  name      String
  leader_id String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  church_id String
  parent_id String?

  leader    Members?      @relation("GroupLeader", fields: [leader_id], references: [id])
  church    Churches      @relation(fields: [church_id], references: [id], onDelete: Cascade)
  members   Members[]     @relation("MemberGroup")
  parent    Groups?       @relation("GroupHierarchy", fields: [parent_id], references: [id], onDelete: SetNull)
  subgroups Groups[]      @relation("GroupHierarchy")
  fields    GroupFields[]

  @@index([church_id])
  @@index([leader_id])
  @@index([parent_id])
  @@map("groups")
}

enum GroupFieldType {
  TEXT
  NUMBER
  BOOLEAN
  DATE
  JSON
}

model GroupFields {
  id        String         @id @default(cuid())
  group_id  String
  key       String
  label     String?
  type      GroupFieldType @default(TEXT)
  value     Json?
  required  Boolean        @default(false)
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")

  group Groups @relation(fields: [group_id], references: [id], onDelete: Cascade)

  @@unique([group_id, key])
  @@index([group_id])
  @@map("group_fields")
}

model MemberMinistry {
  id         String     @id @default(cuid())
  memberId   String     @map("member_id")
  ministryId String     @map("ministry_id")
  church_id  String
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")
  church     Churches   @relation(fields: [church_id], references: [id], onDelete: Cascade)
  member     Members    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  ministry   Ministries @relation(fields: [ministryId], references: [id], onDelete: Cascade)

  @@unique([memberId, ministryId])
  @@index([church_id])
  @@map("member_ministries")
}

enum MemberRole {
  MIEMBRO
  SUPERVISOR
  LIDER
  ANFITRION
  PASTOR
  TESORERO

  @@map("member_role")
}

enum Gender {
  MASCULINO
  FEMENINO

  @@map("gender")
}
